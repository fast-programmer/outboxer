#!/usr/bin/env ruby

require 'bundler/setup'

require 'sidekiq'
require 'outboxer'

require_relative '../app/jobs/event_created_job'

Sidekiq.configure_client do |config|
  config.redis = { url: ENV['REDIS_URL'], size: 5 }
end

Signal.trap('INT') { Outboxer::Message.stop_publishing! }

Outboxer::Message.publish!(
  threads: 25, queue: 100, poll: 0.1,
  logger: Logger.new($stdout, level: Logger::INFO)
) do |message|
  case message['messageable_type']
  when 'Event'
    EventCreatedJob.perform_async({ 'id' => message['messageable_id'] })

    # sleep rand
  end
end

# bin/outboxer_publisher
