#!/usr/bin/env ruby

require "bundler/setup"
require "sidekiq"
require "outboxer"
require_relative "../app/jobs/outboxer_integration/publish_message_job"

cli_options = Outboxer::OptionParser.parse(ARGV)
environment = cli_options[:environment] || ENV["RAILS_ENV"]

config = Outboxer::Config.load(path: options[:config], environment: environment)
config.merge!(options.compact, Outboxer::Config::DEFAULTS)

# puts "Starting Outboxer with configuration: #{config.inspect}" if config[:verbose]

Outboxer::PublisherService.publish(config: config) do |message|
  OutboxerIntegration::PublishMessageJob.perform_async(message.id)
end
