#!/usr/bin/env ruby

require 'bundler/setup'

require 'sidekiq'
require 'outboxer'

require_relative '../app/jobs/outboxer_integration/publish_message_job'

options = {
  env: ENV.fetch('RAILS_ENV', 'development'),
  redis_url: ENV.fetch('REDIS_URL', 'redis://localhost:6379/0'),
  concurrency: ENV.fetch('CONCURRENCY', 1).to_i,
}

Sidekiq.configure_client do |config|
  config.redis = { url: options[:redis_url], size: options[:concurrency] }
end

Outboxer::Publisher.publish(
  env: options[:env], concurrency: options[:concurrency]
) do |message|
  OutboxerIntegration::PublishMessageJob.perform_async({
    'messageable_id' => message[:messageable_id],
    'messageable_type' => message[:messageable_type] })
end
