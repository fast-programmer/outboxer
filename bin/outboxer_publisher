#!/usr/bin/env ruby

require "bundler/setup"
require "sidekiq"
require "outboxer"
require_relative "../app/jobs/outboxer_integration/publish_message_job"

options = Outboxer::OptionParser::DEFAULTS.merge(Outboxer::OptionParser.parse(ARGV))
logger = Outboxer::Logger.new($stdout, level: Logger.const_get(options[:level].upcase))

Sidekiq.configure_client do |config|
  config.redis = { url: ENV["REDIS_URL"], pool: options[:concurrency] }
end

database_config = Outboxer::DatabaseService.config(pool: options[:concurrency])
Outboxer::DatabaseService.connect(config: database_config, logger: logger)

begin
  Outboxer::PublisherService.publish_message(**options) do |message|
    OutboxerIntegration::PublishMessageJob.perform_async(message.id)
  end
ensure
  Outboxer::DatabaseService.disconnect(logger: logger)
end
