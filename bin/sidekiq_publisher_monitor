#!/bin/bash

# Get the PID of bin/sidekiq_publisher
PID=$(pgrep -f bin/sidekiq_publisher)

# Check if the process is running
if [ -z "$PID" ]; then
    echo "bin/sidekiq_publisher process not found."
    exit 1
fi

# Loop to update metrics every second
while true; do
    # Get process stats
    STATS=$(ps -p $PID -o rss=,pcpu=,etime=,vsz=)

    # Read the stats into separate variables
    read RSS CPU ELAPSED VSZ <<< $STATS

    # Convert RSS (memory usage) to MB
    RSS_MB=$(awk "BEGIN {print $RSS/1024}")

    # Convert VSZ (virtual memory size) to MB
    VSZ_MB=$(awk "BEGIN {print $VSZ/1024}")

    echo "PID $PID: Memory Usage: $RSS_MB MB, CPU Usage: $CPU%, Running Time: $ELAPSED, Virtual Memory: $VSZ_MB MB"

    # Wait for 1 second before next update
    sleep 1
done
