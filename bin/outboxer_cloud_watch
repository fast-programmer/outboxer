#!/usr/bin/env ruby

require "bundler/setup"
require "aws-sdk-cloudwatch"
require "outboxer"

environment = ENV["RAILS_ENV"] || "development"
db_config = Outboxer::Database.config(environment: environment, pool: 1)
Outboxer::Database.connect(config: db_config)

running = true

["TERM", "INT"].each do |sig|
  Signal.trap(sig) { running = false }
end

cloud_watch = Aws::CloudWatch::Client.new(
  credentials: Aws::Credentials.new(
    ENV.fetch("AWS_ACCESS_KEY_ID"),
    ENV.fetch("AWS_SECRET_ACCESS_KEY")
  ),
  region: ENV.fetch("AWS_REGION"),
  ssl_verify_peer: false
)

interval = 10
tick = 1

logger = Outboxer::Logger.new($stdout, level: 1)
logger.info "Sending Outboxer metrics to CloudWatch..."

while running
  metrics_by_status = Outboxer::Message.metrics_by_status

  metric_data = metrics_by_status.except(:total).map do |status, metrics|
    {
      metric_name: "MessageCount",
      dimensions: [
        { name: "Status", value: status.to_s.capitalize },
        { name: "Environment", value: environment }
      ],
      value: metrics[:count],
      unit: "Count"
    }
  end + [
    {
      metric_name: "MessageLatency",
      dimensions: [
        { name: "Status", value: "Queued" },
        { name: "Environment", value: environment }
      ],
      value: metrics_by_status[:queued][:latency] || 0,
      unit: "Seconds"
    }
  ]

  cloud_watch.put_metric_data(namespace: "Outboxer", metric_data: metric_data)

  slept = 0

  while running && slept < interval
    sleep tick

    slept += tick
  end
end

logger.info "Shutting down"
